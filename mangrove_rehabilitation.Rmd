---
title: "Mangrove Rehabilitasi"
author: "Erlangga"
date: "2025-09-22"
output: html_document
---

```{r}
library(readr)
library(dplyr)
library(stringr)
library(sf)
library(leaflet)
library(htmltools)
library(leafem)


# Load CSV data
DAS_rehab <- read_csv("wilayah_kerja_das.csv")

# Summarize by working area, aggregate hectares and years
location_summary <- DAS_rehab %>%
  group_by(wil_kerja) %>%
  summarise(
    total_hectare = sum(hectare, na.rm = TRUE),
    years = paste(sort(unique(Year)), collapse = ", "),
    .groups = 'drop'
  )

# Load shapefile and transform to WGS84 lat-long for leaflet
wilayah_kerja_DAS <- st_read("BPDAS_") %>%
  st_transform(crs = 4326)

# Join summarized rehab data to shapefile by working area name
# Assumes 'wil_kerja' exists in both datasets with matching format
joined_sf <- wilayah_kerja_DAS %>%
  left_join(location_summary, by = "wil_kerja")

# Replace NA with zero or "No data" for popup display
joined_sf$total_hectare[is.na(joined_sf$total_hectare)] <- 0
joined_sf$years[is.na(joined_sf$years)] <- "No data"

# Create leaflet interactive map with polygons colored by hectare and popup showing years
pal <- colorNumeric("Blues", domain = joined_sf$total_hectare, na.color = "lightgrey")

map <- leaflet(joined_sf) %>%
  addTiles() %>%
  addPolygons(
    fillColor = ~pal(total_hectare),
    color = "blue",
    weight = 1,
    fillOpacity = 0.5,
    popup = ~paste0(
      "<b>", wil_kerja, "</b><br>",
      "Years: ", years, "<br>",
      "Total Rehabilitated Area: ", total_hectare, " Hectares"
    )
  ) %>%
  addLegend(
    "bottomright",
    pal = pal,
    values = ~total_hectare,
    title = "Rehabilitated Area (Hectares)",
    opacity = 0.7
  ) %>%
  addMouseCoordinates() %>% # This line adds a live coordinate display
  addMiniMap(tiles = providers$OpenStreetMap, position = "bottomleft") # Add minimap


map

library(htmlwidgets)

# Assuming your leaflet map object is named 'map'
saveWidget(map, file = "index.html", selfcontained = TRUE)

# Save the widget with external supporting files directory
saveWidget(map,
           file = "index.html",
           selfcontained = FALSE,
           libdir = "mymap_files")
```


```{r}
library(readr)
library(dplyr)
library(sf)
library(maps)
library(RColorBrewer)

# Load CSV data and summarize by wil_kerja
DAS_rehab <- read_csv("wilayah_kerja_das.csv")
location_summary <- DAS_rehab %>%
  group_by(wil_kerja) %>%
  summarise(
    total_hectare = sum(hectare, na.rm = TRUE),
    years = paste(sort(unique(Year)), collapse = ", "),
    .groups = 'drop'
  )

# Load shapefile of wil_kerja polygons (update filename with correct path and extension)
wilayah_kerja_DAS <- st_read("BPDAS_") %>%
  st_transform(crs = 4326)

# Join rehab summary to spatial polygons by wil_kerja
joined_sf <- wilayah_kerja_DAS %>%
  left_join(location_summary, by = "wil_kerja")

# Replace NA values to avoid plotting issues
joined_sf$total_hectare[is.na(joined_sf$total_hectare)] <- 0

# Define blue palette for total_hectare values
pal_colors <- colorRampPalette(brewer.pal(9, "Blues"))(100)
color_domain <- range(joined_sf$total_hectare, na.rm = TRUE)
color_indices <- findInterval(joined_sf$total_hectare,
                              seq(color_domain[1], color_domain[2], length.out = 100))

# Set plot limits centered on Indonesian BPDAS regions
min_lon <- 90
max_lon <- 150
min_lat <- -15
max_lat <- 15

# Create PDF output
pdf("BPDAS_Rehab_Static_Map.pdf", width = 10, height = 7)
old_par <- par(no.readonly = TRUE)
par(xaxs = "i", yaxs = "i")

# Setup base plot with ocean and land
plot(NA, xlim = c(min_lon, max_lon), ylim = c(min_lat, max_lat), type = "n",
     xlab = "", ylab = "", axes = FALSE)
rect(min_lon, min_lat, max_lon, max_lat, col = "lightblue", border = NA)  # ocean fill
map("world", xlim = c(min_lon, max_lon), ylim = c(min_lat, max_lat),
    col = "grey85", fill = TRUE, add = TRUE)

# Add gridlines and axes with degree labels
abline(v = seq(min_lon, max_lon, 4), col = "grey70", lty = 3)
abline(h = seq(min_lat, max_lat, 4), col = "grey70", lty = 3)
axis(1, at = seq(min_lon, max_lon, 4), labels = paste0(seq(min_lon, max_lon, 4), "°E"), cex.axis = 0.7)
axis(2, at = seq(min_lat, max_lat, 4), labels = paste0(abs(seq(min_lat, max_lat, 4)),
       ifelse(seq(min_lat, max_lat, 4) < 0, "°S", "°N")), cex.axis = 0.7)

# Plot BPDAS polygons colored by their rehab hectares
plot(st_geometry(joined_sf), col = pal_colors[color_indices], border = "blue", add = TRUE)

# Draw color legend on right side
colorbar_x <- max_lon - 10
colorbar_y_bottom <- min_lat + 2
colorbar_y_top <- colorbar_y_bottom + 8
rect(colorbar_x - 0.2, colorbar_y_bottom - 0.2,
     colorbar_x + 1.5, colorbar_y_top + 0.2, col = "white", border = NA)
legend_image <- as.raster(matrix(rev(pal_colors), ncol = 1))
rasterImage(legend_image, colorbar_x, colorbar_y_bottom, colorbar_x + 1, colorbar_y_top)
legend_labels <- round(seq(color_domain[1], color_domain[2], length.out = 5))
legend_ypos <- seq(colorbar_y_bottom, colorbar_y_top, length.out = 5)
for (i in seq_along(legend_labels)) {
  text(colorbar_x + 1.5, legend_ypos[i], legend_labels[i], cex = 0.7, adj = 0)
}
text(colorbar_x + 0.75, colorbar_y_top + 0.8, "Rehabilitated Area (Hectares)", cex = 0.8)

# Add scale bar
scalebar_length <- 200
scalebar_x <- min_lon + 1
scalebar_y <- min_lat + 1
rect(scalebar_x, scalebar_y, scalebar_x + 2, scalebar_y + 0.2, col = "black")
text(scalebar_x + 1, scalebar_y - 0.4, paste0(scalebar_length, " km"), adj = 0.5, cex = 0.7)

# Add north arrow
north_x <- max_lon - 1.5
north_y <- max_lat - 1
text(north_x, north_y, "N", cex = 1.1, font = 2)

# Finish plot and close device
par(old_par)
dev.off()

```

